//i am kmh0228   QQ 1150123276
/*
			var select=new SelectBox(obj,data,fn,opts);//建立 select框对象
			参数说明  obj : jquery对象
					data : 下拉框里的数据(数据)，数组里可以是值，也可以是json，如果是json有对应的dataName和dataId
					fn  :  回掉函数 参数为 {name:name,id:id}//name是输入框内容  id是隐藏value
					opts:  {},设置参数
						dataName:'name',//option的html
						dataId:'id',//option的value						
						fontSize:'14',//字体大小
						optionFontSize:'14',//下拉框字体大小
						textIndent:4,//字体缩进						
						color:'#000',//输入框字体颜色
						optionColor:'#000',//下拉框字体颜色
						arrowColor:'green',//箭头颜色
						backgroundColor:'#ccc',//背景色颜色
						borderColor:'green',//边线颜色
						hoverColor:'green',//下拉框HOVER颜色						
						borderWidth:1,//边线宽度
						arrowBorderWidth:0,//箭头左侧分割线宽度。如果为0则不显示
						borderRadius:5,//边线圆角						
						placeholder:'请输入文字',//默认提示
						defalut:'firstData',//默认显示内容。如果是'firstData',则默认显示第一个
						retur:false,//是否阻止在建立数据后调用回掉函数
						allowInput:true,//是否允许输入						
						width:130,//宽
						height:26,//高
						optionMaxHeight:500//下拉框最大高度
						
			方法  changeList(data,opts) 改变数据,data为数据，opts为参数{retur:false;//是否阻止在建立数据后调用回掉函数}
				changeFnBack(fn)  改变回掉函数
				getResult()       获取当前选择项	
				close()           隐藏下拉框
				setValue(name)		设置框内的值
*/

function SelectBox(b, c, d, e) {
	var b = this.obj = b;
	var c = this.data = c || [];
	var e = this.opts = e || {};
	var f = this.dataName = e.dataName || 'name';
	var g = this.dataId = e.dataId || 'id';
	var h = this.fontSize = e.fontSize || '14';
	var i = e.optionFontSize || '14';
	var j = this.textIndent = e.textIndent || 4;
	var k = this.color = e.color || '#000';
	var l = e.optionColor || '#000';
	var m = e.arrowColor || '#5c5c5c';
	var n = e.borderColor || '#c2c2c2';
	var o = this.hoverColor = e.hoverColor || '#6fc';
	var p = e.backgroundColor || '#fff';
	var q = this.placeholder = e.placeholder || '';
	var r = this.defalut = e.defalut || '';
	var s = this.width = e.width || 130;
	var t = this.height = e.height || 26;
	var u = e.optionMaxHeight || 350;
	var v = this.borderWidth = e.borderWidth || 1;
	var w = e.borderRadius || 0;
	var x = typeof e.arrowBorderWidth == 'undefined' ? v : e.arrowBorderWidth;
	var y = this.allowInput = typeof e.allowInput == 'undefined' ? true : e.allowInput;
	this.fnBack = d;
	var z = this;
	this.fn = function(a) {
		z.result = a;
		this.fnBack && this.fnBack(a)
	};
	b.html('<input type="text" value="' + r + '" placeholder="' + q + '"/>				<div class="overlay"></div>				<i><em></em></i>				<ul>				</ul>');
	var A = this.ul = b.find('ul');
	var B = this.input = b.find('input');
	var C = this.retur = e.retur || false;
	this.changeList(c, {
		retur: C
	});
	var D = b.css('position') == 'static' ? 'relative' : b.css('position');
	b.css({
		'width': s,
		'height': t,
		'position': D,
		'border': v + 'px solid ' + n,
		'border-radius': w + 'px',
		'background': p
	});
	b.find('*').css({
		'margin': 0,
		'padding': 0
	});
	B.css({
		'color': k,
		'width': '100%',
		'height': '100%',
		'font-size': h + 'px',
		'text-indent': j + 'px',
		'border': 'none',
		'background': 'none',
		'outline': 'none'
	});
	var E = b.find('.overlay');
	E.css({
		'position': 'absolute',
		'top': 0,
		'right': 0,
		'width': '100%',
		'height': '0'
	});
	b.find('i').css({
		'width': t,
		'height': '100%',
		'position': 'absolute',
		'top': 0,
		'right': 0,
		'border-left': x + 'px solid ' + n,
		'cursor': 'pointer'
	});
	var F = parseInt(t / 4);
	var G = parseInt(t * 3 / 8);
	b.find('i em').css({
		'display': 'block',
		'width': '0px',
		'border': F + 'px solid transparent',
		'border-top': F + 'px solid ' + m,
		'margin': G + 'px auto'
	});
	b.find('ul').css({
		'position': 'absolute',
		'color': l,
		'font-size': i + 'px',
		'width': '100%',
		'left': -v,
		'top': t + v,
		'border-left': v + 'px solid ' + n,
		'border-right': v + 'px solid ' + n,
		'border-bottom': v + 'px solid ' + n,
		'background': p,
		'z-index': 999,
		'display': 'none',
		'max-height': u + 'px',
		'overflow-Y': 'auto',
		'border-radius': w + 'px'
	});
	if (!y) {
		B.on('focus', function() {
			B.blur()
		});
		E.css({
			'cursor': 'pointer',
			'height': '100%'
		});
		E.on('click', function() {
			A.toggle()
		})
	}
	this.addEvent()
}
SelectBox.prototype.addEvent = function() {
	var k = this.ul;
	var l = this.input;
	var m = this.obj;
	var o = this;
	k.on('click', 'li', function() {
		k.hide();
		var a = $(this).html();
		var b = $(this).attr('index_id');
		l.val(a).attr('index_id', b);
		o.fn && o.fn({
			name: a,
			id: b
		})
	});
	m.off('click');
	m.on('click', 'i', function() {
		k.toggle()
	});
	$(document).on('focus', 'input', function() {
		if (!m.has($(this)).length) {
			k.hide()
		}
	});
	$(document).on('click', function(e) {
		var a = e.srcElement || e.target;
		if (!m.has(a).length) {
			k.hide()
		}
	});
	this.allowInput && l.focus(function() {
		k.show();
		var f = $(this);
		var g = f.val().replace(' ', '');
		f.timer = setInterval(function() {
			var c = f.val().replace(' ', '');
			if (c != g) {
				g = c;
				if (c == '') {
					k.children().show();
					o.fn && o.fn({
						name: '',
						id: ''
					});
					return
				} else {
					k.children().hide();
					k.children(':contains(' + g + ')').show();
					var d = false;
					k.find('li').each(function(i, e) {
						var a = e.innerHTML;
						if (a == g) {
							d = true;
							var b = $(e).attr('index_id');
							o.fn && o.fn({
								name: a,
								id: b
							});
							return false
						}
					});
					if (!d) {
						o.fn && o.fn({
							name: g,
							id: 'error'
						})
					}
				}
			}
		}, 30);
		var h = function() {
				clearInterval(f.timer);
				f.off('blur');
				f.off('keydown')
			};
		f.on('blur', h);
		var j = function(a) {
				var b = k.children('li:visible').length;
				switch (a.keyCode) {
				case 40:
					o.n++;
					if (o.n > b) {
						o.n = b
					}
					var n = o.n;
					k.children('li').css('background', 'none');
					k.children('li:visible').eq(n - 1).css('background', o.hoverColor);
					if (n * k.children('li:visible').height() > k.height()) {
						k.scrollTop(n * k.children('li:visible').height() - k.height())
					}
					return false;
					break;
				case 38:
					o.n--;
					if (o.n < 1) {
						o.n = 1
					}
					var n = o.n;
					k.children('li').css('background', 'none');
					k.children('li:visible').eq(n - 1).css('background', o.hoverColor);
					if ((n - 1) * k.children('li:visible').height() < k.scrollTop()) {
						k.scrollTop((n - 1) * k.children('li:visible').height() || 0)
					}
					return false;
					break;
				case 13:
					if (o.n) {
						var c = k.children('li:visible').eq(o.n - 1).attr('index_id');
						var d = k.children('li:visible').eq(o.n - 1).html();
						l.val(d).attr('index_id', c);
						o.fn && o.fn({
							name: d,
							id: c
						})
					}
					f.blur();
					k.hide();
					return false;
					break
				}
			}
		f.on('keydown', j);
		return false
	})
};
SelectBox.prototype.changeList = function(a, b) {
	if (!this.input) return;
	var b = b || {};
	var c = b.retur || false;
	var d = a.length;
	var e = this.ul;
	var f = '';
	if (!d) {
		e.html(f);
		this.input.val('').attr('index_id', '');
		return
	}
	var g = this;
	var h = this.obj;
	var j = this.dataName;
	var k = this.dataId;
	if (a[0].constructor == Object) {
		var l = this.data = a
	} else {
		var m = [];
		for (i = 0; i < d; i++) {
			var n = {};
			n[j] = a[i];
			n[k] = a[i];
			m.push(n)
		}
		var l = this.data = m
	};
	var o = {};
	switch (this.defalut) {
	case '':
		o.name = '';
		o.id = '';
		break;
	case 'firstData':
		o.name = l[0][j];
		o.id = l[0][k];
		break;
	default:
		o.name = this.defalut;
		o.id = '';
		for (i = 0; i < d; i++) {
			if (l[i][j] == this.defalut) {
				o.id = l[i][k];
				break
			}
		}
		break
	}
	this.input.val(o.name).attr('index_id', o.id);
	(!this.retur) && this.fn && this.fn(o);
	this.n = 0;
	for (i = 0; i < d; i++) {
		var p = l[i];
		f += '<li index_id="' + p[k] + '">' + p[j] + '</li>'
	}
	e.html(f);
	e.find('li').css({
		'list-style': 'none',
		'text-indent': this.textIndent + 'px',
		'height': this.height,
		'font-size': this.fontSize,
		'line-height': this.height + 'px',
		'white-space': 'nowrap',
		'cursor': 'pointer',
		'overflow': 'hidden'
	});
	e.find('li').hover(function() {
		$(this).css('background', g.hoverColor).siblings().css('background', 'none');
		g.n = h.find('li:visible').index($(this)) + 1
	}, function() {
		$(this).css('background', 'none')
	})
};
SelectBox.prototype.changeFnBack = function(a) {
	this.fnBack = fnBack
};
SelectBox.prototype.getResult = function() {
	return this.result
};
SelectBox.prototype.close = function() {
	this.ul.hide()
};
SelectBox.prototype.setValue = function(a) {
	var b = this.defalut;
	this.defalut = a;
	this.changeList(this.data);
	this.defalut = b
};